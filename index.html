<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Attendance System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- QR Code Generator CDN (for Admin view) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
      type="text/javascript"
    ></script>
    <!-- HTML5 QR Code Scanner CDN (for Student view) -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <!-- Modal for Messages -->
    <div
      id="message-modal"
      class="modal fixed inset-0 hidden items-center justify-center p-4"
    >
      <div class="bg-white card rounded-xl p-6 w-full max-w-sm">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
        <p id="modal-body" class="text-gray-600 mb-6"></p>
        <button id="modal-close-btn" class="btn-primary w-full">Close</button>
      </div>
    </div>

    <div id="app" class="w-full max-w-5xl">
      <!-- Header -->
      <header
        class="bg-white card rounded-xl p-4 mb-6 flex justify-between items-center"
      >
        <h1 class="text-3xl font-extrabold text-indigo-700">Attendance QR</h1>
        <div id="user-info" class="flex items-center space-x-4">
          <span
            id="welcome-message"
            class="text-lg font-medium text-gray-600"
          ></span>
          <button id="logout-btn" class="hidden btn-secondary text-sm">
            Logout
          </button>
        </div>
      </header>

      <!-- Main Content Area -->
      <main id="content" class="bg-white card rounded-xl p-8"></main>
    </div>

    <script>
      // =========================================================================
      // CORE UTILITIES & STATE MANAGEMENT (Acts like a global 'app.js' module)
      // =========================================================================

      const API_BASE = "https://minor-project-qr-backend-1.onrender.com";

      // Global State
      let user = JSON.parse(localStorage.getItem("user")) || null;
      let qrCodeScanner = null;

      // DOM Elements
      const contentDiv = document.getElementById("content");
      const logoutBtn = document.getElementById("logout-btn");
      const welcomeMessage = document.getElementById("welcome-message");
      const modal = document.getElementById("message-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const modalCloseBtn = document.getElementById("modal-close-btn");

      /** Shows a custom styled message modal */
      function showMessage(title, message, onModalClose = null) {
        // Stop the scanner immediately, forcing restart via button
        if (qrCodeScanner) {
          stopQrScanner(true);
        }

        modalTitle.textContent = title;
        modalBody.innerHTML = message.replace(/\n/g, "<br>");
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        modalCloseBtn.onclick = () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          if (onModalClose) {
            onModalClose(); // Execute callback after modal closes
          }
        };
      }

      /** Handles API requests with proper JSON headers and error handling. */
      async function apiFetch(endpoint, options = {}) {
        try {
          const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
          });

          const data = await response.json();

          if (!response.ok) {
            const errorMessage =
              data.error || data.message || `API Error: ${response.statusText}`;
            showMessage("Error", errorMessage);
            return null;
          }
          return data;
        } catch (error) {
          console.error("Network or Parsing Error:", error);
          showMessage(
            "Network Error",
            "Could not connect to the backend server. Make sure the Flask app is running on 127.0.0.1:5000."
          );
          return null;
        }
      }
      /* Stops the active QR scanner and resets control buttons. */
      /** * Stops the active QR scanner and resets control buttons. */
      function stopQrScanner(silent = false) {
        const startBtn = document.getElementById("start-scan-btn");
        const stopBtn = document.getElementById("stop-scan-btn");
        const readerDiv = document.getElementById("reader");
        const scanStatus = document.getElementById("scan-status");

        // Store a reference to the active scanner
        const scannerToStop = qrCodeScanner;

        // ðŸŒŸ CRITICAL FIX 1: Immediately clear the global reference
        // This allows startQrScanner() or handleLogout() to proceed without waiting.
        qrCodeScanner = null;

        // 1. IMMEDIATE UI UPDATE: Transition the buttons and hide the container
        if (startBtn) startBtn.classList.remove("hidden");
        if (stopBtn) stopBtn.classList.add("hidden");
        if (readerDiv) readerDiv.classList.add("hidden"); // Use class to hide
        if (scanStatus) scanStatus.textContent = "Stopping scanner...";

        if (scannerToStop) {
          // 2. Perform asynchronous stop on the old instance
          scannerToStop
            .stop()
            .then(() => {
              if (!silent)
                console.log("QR Code scanning stopped successfully.");
            })
            .catch((err) => {
              if (!silent)
                console.log(
                  "Scanner stop error (possibly already stopped):",
                  err
                );
            })
            .finally(() => {
              // Final Cleanup: Clear container HTML and confirm status
              if (readerDiv) readerDiv.innerHTML = ""; // ðŸŒŸ CRITICAL FIX 2: Wipe the container clean
              if (scanStatus) scanStatus.textContent = "Scanner is inactive.";
            });
        } else {
          // If no scanner was active, just ensure the UI is in the default state
          if (readerDiv) readerDiv.innerHTML = "";
          if (scanStatus) scanStatus.textContent = "Scanner is inactive.";
        }
      }
      /** Updates the header and navigates to the correct dashboard based on user state. */
      /** Updates the header and navigates to the correct dashboard based on user state. */
      function navigate() {
        // Always stop scanner before rendering a new view
        stopQrScanner(true);
        contentDiv.innerHTML = "";

        if (user) {
          // ðŸŒŸ CRITICAL FIX: Only display the roll number if the user is a student
          // AND the rollno is a non-empty, non-placeholder value.
          let rollDisplay = "";
          if (user.role === "student" && user.rollno && user.rollno !== "N/A") {
            rollDisplay = ` (${user.rollno})`;
          }

          welcomeMessage.textContent = `Welcome, ${user.name}${rollDisplay} (${user.role})`;
          logoutBtn.classList.remove("hidden");

          if (user.role === "admin") {
            renderAdminDashboard();
          } else if (user.role === "student") {
            renderStudentDashboard();
          } else {
            renderAuthView();
          }
        } else {
          welcomeMessage.textContent = "Please Login or Register";
          logoutBtn.classList.add("hidden");
          renderAuthView();
        }
      }

      // =========================================================================
      // AUTHENTICATION/LOGIN LOGIC (Acts like a 'login.js' module)
      // =========================================================================

      function handleAuthSuccess(userData) {
        user = userData;
        localStorage.setItem("user", JSON.stringify(user));
        navigate();
      }

      async function handleLogin(e) {
        e.preventDefault();
        const username = e.target.username.value;
        const password = e.target.password.value;

        const data = await apiFetch("/login", {
          method: "POST",
          body: JSON.stringify({ username, password }),
        });

        if (data) {
          // Show message, then call handleAuthSuccess only AFTER modal closes
          showMessage("Success", data.message || "Login successful!", () =>
            handleAuthSuccess(data)
          );
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        const name = e.target.name.value;
        const username = e.target.username.value;
        const password = e.target.password.value;
        const role = e.target.role.value;
        // Send rollno regardless, backend will ignore it if role is admin
        const rollno = e.target.rollno.value;

        const data = await apiFetch("/register", {
          method: "POST",
          body: JSON.stringify({ name, username, password, role, rollno }),
        });

        if (data) {
          const authForm = document.getElementById("auth-form");
          if (authForm) authForm.reset();

          showMessage(
            "Registration Success",
            data.message + "\n\nPlease proceed to login.",
            () => {
              // Switch to login view after modal dismisses
              const showLoginBtn = document.getElementById("show-login");
              if (showLoginBtn) showLoginBtn.click();
            }
          );
        }
      }

      function handleLogout() {
        // 1. Call stopQrScanner (silent = true) to immediately reset scanner state
        stopQrScanner(true);

        // 2. Clear user state and localStorage
        user = null;
        localStorage.removeItem("user");

        // 3. Navigate to the login screen
        navigate();

        // 4. Show confirmation message
        showMessage("Logged Out", "You have been successfully logged out.");
      }

      function renderAuthView() {
        contentDiv.innerHTML = `
                <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Welcome to the Attendance System</h2>
                    
                    <div class="flex space-x-2 mb-6">
                        <button id="show-login" class="flex-1 btn-primary">Login</button>
                        <button id="show-register" class="flex-1 btn-secondary">Register</button>
                    </div>

                    <form id="auth-form" class="space-y-4 bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <div id="role-select">
                            <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                            <select id="role" name="role" required class="input-field">
                                <option value="student">Student</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        
                        <!-- Full Name Container (Toggled in JS) -->
                        <div id="name-container" class="hidden">
                            <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="name" name="name" placeholder="" required class="input-field">
                        </div>
                        
                        <!-- ROLL NUMBER INPUT CONTAINER (Toggled in JS) -->
                        <div id="rollno-container">
                            <label for="rollno" class="block text-sm font-medium text-gray-700">Roll Number</label>
                            <input type="text" id="rollno" name="rollno" placeholder="" required class="input-field">
                        </div>

                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="username" name="username" placeholder="" required class="input-field">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" name="password" placeholder="" required class="input-field">
                        </div>
                        
                        <button type="submit" id="submit-btn" class="btn-primary w-full">Login</button>
                    </form>
                </div>
            `;

        const authForm = document.getElementById("auth-form");
        const showLoginBtn = document.getElementById("show-login");
        const showRegisterBtn = document.getElementById("show-register");
        const roleSelect = document.getElementById("role");

        // New references
        const nameContainer = document.getElementById("name-container");
        const nameInput = document.getElementById("name");

        const rollnoContainer = document.getElementById("rollno-container");
        const rollnoInput = document.getElementById("rollno");
        const submitBtn = document.getElementById("submit-btn");

        let isLogin = true;

        function updateRegistrationFields(selectedRole) {
          if (selectedRole === "student") {
            rollnoContainer.classList.remove("hidden");
            rollnoInput.required = true;
            rollnoInput.value = ""; // Clear for new input
          } else {
            rollnoContainer.classList.add("hidden");
            rollnoInput.required = false;
            // Important: Set rollno to a dummy value so it's sent to the backend but is not an empty string
            rollnoInput.value = "N/A";
          }
        }

        function updateForm(loginMode) {
          isLogin = loginMode;

          // Show/Hide Role Select (Always shown during Registration)
          roleSelect.parentElement.classList.toggle("hidden", loginMode);
          // Toggle the Full Name container visibility
          nameContainer.classList.toggle("hidden", loginMode);

          if (isLogin) {
            showLoginBtn.classList.replace("btn-secondary", "btn-primary");
            showRegisterBtn.classList.replace("btn-primary", "btn-secondary");

            nameInput.required = false;

            rollnoContainer.classList.add("hidden");
            rollnoInput.required = false;

            submitBtn.textContent = "Login";
            authForm.onsubmit = handleLogin;
            roleSelect.removeEventListener("change", updateRegistrationFields);
          } else {
            showRegisterBtn.classList.replace("btn-secondary", "btn-primary");
            showLoginBtn.classList.replace("btn-primary", "btn-secondary");

            nameInput.required = true;

            submitBtn.textContent = "Register";
            authForm.onsubmit = handleRegister;

            // Initial state for Register (defaults to Student)
            updateRegistrationFields(roleSelect.value);

            // Add listener to role change event
            roleSelect.addEventListener("change", (e) =>
              updateRegistrationFields(e.target.value)
            );
          }
        }

        // Initial state: Login
        updateForm(true);

        showLoginBtn.addEventListener("click", () => updateForm(true));
        showRegisterBtn.addEventListener("click", () => updateForm(false));
      }

      // =========================================================================
      // ADMIN DASHBOARD LOGIC (Acts like an 'admin.js' module)
      // =========================================================================

      let qrCodeInstance = null; // Holds the QRCode object

      function renderAdminDashboard() {
        contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-2">Admin Dashboard</h2>
                
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Create Session Card -->
                    <div class="card p-6 bg-indigo-50 rounded-xl">
                        <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Start New Session</h3>
                        <form id="create-session-form" class="space-y-3">
                            <div>
                                <input type="text" id="class_name" placeholder="Class Name (e.g., Computer Science 101)" required class="input-field">
                            </div>
                            <div>
                                <input type="text" id="class_code" placeholder="Class Code (e.g., CS101)" required class="input-field">
                            </div>
                            <button type="submit" class="btn-primary w-full">Generate QR Code</button>
                        </form>
                    </div>

                    <!-- QR Code Display -->
                    <div class="card p-6 bg-white rounded-xl flex flex-col items-center">
                        <h3 class="text-2xl font-semibold text-gray-700 mb-4">Active Session QR</h3>
                        <div id="qrcode" class="p-2 border-4 border-indigo-500 rounded-lg bg-white mb-4">
                            <p class="text-gray-500">Generate a session to see the QR code.</p>
                        </div>
                        <p id="qr-token-display" class="text-sm text-gray-600 truncate w-full text-center"></p>
                    </div>
                </div>

                <!-- Attendance Overview -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Student Attendance Summary</h3>
                    <div id="stats-table-container" class="overflow-x-auto">
                        <!-- Stats Table will be injected here -->
                    </div>
                </div>

                <!-- Detailed Attendance Records -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">All Attendance Records</h3>
                    <button id="export-excel-btn" class="btn-secondary text-sm">Export to Excel</button> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
                    <div id="records-table-container" class="overflow-x-auto">
                        <!-- Records Table will be injected here -->
                    </div>
                </div>
            `;

        document.getElementById("create-session-form").onsubmit =
          handleCreateSession;
        document
          .getElementById("export-excel-btn")
          .addEventListener("click", exportDataFromBackend);
        fetchAdminData();
      }

      async function handleCreateSession(e) {
        e.preventDefault();
        const class_name = e.target.class_name.value;
        const class_code = e.target.class_code.value;

        const data = await apiFetch("/admin/create_session", {
          method: "POST",
          body: JSON.stringify({ class_name, class_code }),
        });

        if (data) {
          generateQrCode(data.qr_token);
          showMessage(
            "Session Created",
            `A new session for ${class_code} is active. Share the QR code with students.`
          );
          e.target.reset();
          fetchAdminData();
        }
      }

      function generateQrCode(token) {
        const qrDiv = document.getElementById("qrcode");
        const tokenDisplay = document.getElementById("qr-token-display");

        // Clear previous QR code
        qrDiv.innerHTML = "";
        qrCodeInstance = new QRCode(qrDiv, {
          text: token,
          width: 200,
          height: 200,
          colorDark: "#1f2937",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        tokenDisplay.textContent = `Token: ${token}`;
      }

      // =========================================================================
      // EXPORT UTILITY FUNCTION
      // =========================================================================
      /**
       * Converts an HTML table (within a specified container) to a downloadable CSV file.
       */
      // =========================================================================
      // EXPORT DATA DIRECTLY FROM BACKEND
      // =========================================================================
      /**
       * Fetches all attendance records from the backend API and exports the data
       * as a downloadable CSV file, which opens in Excel.
       */
      async function exportDataFromBackend(
        filename = "All_Attendance_Records"
      ) {
        showMessage(
          "Exporting...",
          "Fetching all records from the server...",
          "bg-yellow-500"
        );

        try {
          // Assume the endpoint to get ALL records is /admin/records
          const records = await apiFetch("/admin/records", { method: "GET" });

          if (!records || records.length === 0) {
            showMessage(
              "Export Failed",
              "No attendance records found on the server.",
              "bg-red-500"
            );
            return;
          }

          // --- Data Processing: Convert JSON to CSV ---

          // 1. Determine Headers: Use keys from the first object
          const headers = Object.keys(records[0]).map((header) => {
            // Capitalize first letter and replace underscores with spaces for readability
            return (
              header.charAt(0).toUpperCase() +
              header.slice(1).replace(/_/g, " ")
            );
          });

          // 2. Build the CSV content
          let csv = [];

          // Add header row first, ensuring proper quoting
          csv.push(headers.map((h) => `"${h}"`).join(","));

          // Add data rows
          records.forEach((record) => {
            const row = headers.map((header) => {
              const key = header.toLowerCase().replace(/ /g, "_");
              let data = String(record[key] !== undefined ? record[key] : "");

              // Escape quotes inside data by doubling them, then wrap the cell in quotes
              data = data.replace(/"/g, '""').trim();
              return `"${data}"`;
            });
            csv.push(row.join(","));
          });

          const csvFile = csv.join("\n");

          // --- Download: Create Blob and Trigger Download ---

          const blob = new Blob([csvFile], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");

          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename + ".csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage(
              "Export Complete",
              `Successfully exported ${records.length} records to ${filename}.csv.`,
              "bg-green-500"
            );
          } else {
            showMessage(
              "Export Failed",
              "Your browser does not support automatic downloads.",
              "bg-red-500"
            );
          }
        } catch (error) {
          console.error("Export Error:", error);
          showMessage(
            "Export Failed",
            "An error occurred while fetching or processing data.",
            "bg-red-500"
          );
        }
      }

      async function fetchAdminData() {
        const data = await apiFetch("/admin/attendance", { method: "GET" });

        if (data) {
          renderStatsTable(data.stats);
          renderRecordsTable(data.records);

          if (data.current_qr_token && !qrCodeInstance) {
            generateQrCode(data.current_qr_token);
          } else if (!data.current_qr_token) {
            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML =
              '<p class="text-gray-500">No active session found. Create one above.</p>';
            document.getElementById("qr-token-display").textContent = "";
          }
        }
      }

      function renderStatsTable(stats) {
        const container = document.getElementById("stats-table-container");
        if (stats.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500">No student data available. Ask students to register.</p>';
          return;
        }

        const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Attended</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Classes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Percentage</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${stats
                          .map(
                            (stat) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                                  stat.name
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${
                                  stat.attended
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${
                                  stat.total
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${
                                  stat.percentage < 50
                                    ? "text-red-600"
                                    : "text-green-600"
                                }">${stat.percentage}%</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }

      function renderRecordsTable(records) {
        const container = document.getElementById("records-table-container");
        if (records.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500">No attendance records yet.</p>';
          return;
        }

        const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Student</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Roll No.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Class</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Code</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Time</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${records
                          .map(
                            (record) => `
                            <tr class="hover:bg-gray-50" data-id="${record.id}">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${
                                  record.student_name
                                }</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${
                                  record.roll_no || "N/A"
                                }</td> 
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${
                                  record.class_name
                                }</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${
                                  record.class_code
                                }</td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="status-display font-semibold ${
                                      record.status === "Present"
                                        ? "text-green-600"
                                        : "text-red-600"
                                    }">
                                        ${record.status}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">${new Date(
                                  record.timestamp
                                ).toLocaleString()}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <select class="status-select input-field p-1 text-sm bg-white" onchange="handleStatusChange(${
                                      record.id
                                    }, this.value)">
                                        <option value="Present" ${
                                          record.status === "Present"
                                            ? "selected"
                                            : ""
                                        }>Present</option>
                                        <option value="Absent" ${
                                          record.status === "Absent"
                                            ? "selected"
                                            : ""
                                        }>Absent</option>
                                    </select>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }

      async function handleStatusChange(recordId, newStatus) {
        const data = await apiFetch("/admin/update_attendance", {
          method: "POST",
          body: JSON.stringify({ record_id: recordId, status: newStatus }),
        });

        if (data) {
          // Quick UI update (before full re-fetch)
          const row = document.querySelector(`tr[data-id="${recordId}"]`);
          if (row) {
            const statusSpan = row.querySelector(".status-display");
            statusSpan.textContent = newStatus;
            statusSpan.classList.remove("text-green-600", "text-red-600");
            statusSpan.classList.add(
              newStatus === "Present" ? "text-green-600" : "text-red-600"
            );
          }
          showMessage(
            "Update Success",
            `Attendance for record ID ${recordId} set to ${newStatus}.`
          );
          fetchAdminData();
        }
      }

      // =========================================================================
      // STUDENT DASHBOARD LOGIC (Acts like a 'student.js' module)
      // =========================================================================

      function renderStudentDashboard() {
        contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-2">Student Dashboard</h2>
                
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Attendance Marker Card: Controlled by Button -->
                    <div class="card p-6 bg-indigo-50 rounded-xl flex flex-col justify-between">
                        <div>
                            <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Scan QR to Mark Attendance</h3>
                            <p class="text-gray-600 mb-4">Click "Start Camera" to enable QR scanning and mark your attendance.</p>
                            
                            <!-- Scanner Controls -->
                            <div id="scanner-controls" class="space-y-4 mb-4">
                                <button id="start-scan-btn" class="btn-primary w-full">Start Camera</button>
                                <button id="stop-scan-btn" class="btn-danger w-full hidden">Stop Camera</button>
                            </div>

                            <!-- QR Scanner Container -->
                            <div id="reader" class="my-4 hidden"></div>
                            <p id="scan-status" class="text-center text-sm font-medium text-gray-500">Scanner is inactive.</p>
                        </div>
                    </div>

                    <!-- Personal Stats Card -->
                    <div id="student-stats-card" class="card p-6 bg-white rounded-xl">
                        <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Your Statistics</h3>
                        <div id="stats-content" class="space-y-2 text-lg">
                            <p>Loading stats...</p>
                        </div>
                    </div>
                </div>
            `;

        // Attach event listeners to the new buttons
        document
          .getElementById("start-scan-btn")
          .addEventListener("click", startQrScanner);
        document
          .getElementById("stop-scan-btn")
          .addEventListener("click", () => stopQrScanner(false));

        // Fetch stats immediately
        fetchStudentStats(user.user_id);
      }

      /** * Stops the active QR scanner and resets control buttons. */
      function startQrScanner() {
        // Check global state
        if (qrCodeScanner) return;

        // ... (variable definitions and UI updates) ...

        // Initialize the lower-level Html5Qrcode class
        qrCodeScanner = new Html5Qrcode("reader");

        const onScanSuccess = (decodedText, decodedResult) => {
          // Pass the raw text to the handler
          handleMarkAttendance(decodedText);
        };

        // ðŸŒŸ CRITICAL FIX: Enhanced Configuration for Mobile Scanning
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          // Set a longer delay after successful scan before stopping
          disableFlip: false,
          // Set the aspect ratio for better mobile scanning
          aspectRatio: 1.0,
        };

        // 3. Start the scanning process immediately
        qrCodeScanner
          .start(
            // Request the back camera ('environment') on mobile devices
            { facingMode: "environment" },
            config,
            onScanSuccess,
            (errorMessage) => {
              // Update status text while scanning is active
              if (scanStatus)
                scanStatus.textContent = "Scanning for QR Code...";
            }
          )
          .catch((err) => {
            // ... (error handling remains the same) ...
          });
      }

      async function handleMarkAttendance(qr_token_raw) {
        // ðŸŒŸ CRITICAL FIX: Trim any leading/trailing whitespace from the scanned text
        showMessage(
          "Token Read:",
          `The scanner read: ${qr_token}`,
          "bg-purple-500"
        );

        const qr_token = qr_token_raw.trim().toUpperCase();

        const data = await apiFetch("/student/mark_attendance", {
          method: "POST",
          body: JSON.stringify({ student_id: user.user_id, qr_token }),
        });

        if (data) {
          // Stop scanner upon successful attendance marking
          stopQrScanner(true);
          showMessage("Attendance Marked!", data.message);
          fetchStudentStats(user.user_id);
        }
      }

      async function fetchStudentStats(studentId) {
        const data = await apiFetch(`/student/stats/${studentId}`, {
          method: "GET",
        });
        const statsContent = document.getElementById("stats-content");

        if (data && statsContent) {
          // Safely calculate corrected values based on backend data
          const totalClasses = data.total_classes || 0;
          // Cap attended at the total classes to prevent over-attendance
          const attendedCapped = Math.min(data.attended || 0, totalClasses);

          // Calculate Missed (will be 0 if attended > total)
          const missedCapped = Math.max(0, totalClasses - attendedCapped);

          // Calculate Percentage (will be max 100% if attended > total)
          let percentageCapped = 0;
          if (totalClasses > 0) {
            percentageCapped = Math.min(
              100,
              Math.round((attendedCapped / totalClasses) * 100)
            );
          }

          const percentageColor =
            percentageCapped >= 50 ? "text-green-600" : "text-red-600";

          statsContent.innerHTML = `
                    <p><span class="font-bold text-indigo-700">Roll Number:</span> ${
                      user.rollno || "N/A"
                    }</p> 
                    <p><span class="font-bold text-indigo-700">Total Classes:</span> ${totalClasses}</p>
                    <p><span class="font-bold text-green-700">Attended:</span> ${attendedCapped}</p>
                    <p><span class="font-bold text-red-700">Missed:</span> ${missedCapped}</p>
                    <p class="pt-4 text-2xl font-extrabold ${percentageColor}">Attendance Rate: ${percentageCapped}%</p>
                `;
        } else if (statsContent) {
          statsContent.innerHTML =
            '<p class="text-gray-500">Could not load statistics.</p>';
        }
      }

      // =========================================================================
      // INITIALIZATION
      // =========================================================================

      logoutBtn.addEventListener("click", handleLogout);

      // Run navigation on load to show the correct view (Auth, Admin, or Student)
      navigate();
    </script>
  </body>
</html>
