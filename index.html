<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css" /> 
    
    <style>
      .input-field {
        @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
      }
      .btn-primary {
        @apply bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150;
      }
      .btn-secondary {
        @apply bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition duration-150;
      }
      /* Ensure the scanner area is visible and square */
      #scanner-container {
        width: 100%; 
        aspect-ratio: 1 / 1; 
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        background-color: black;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4 bg-gray-50 font-sans">
    
    <div id="message-modal" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
      <div class="bg-black opacity-50 absolute inset-0"></div>
      <div class="bg-white card p-6 rounded-xl shadow-2xl z-10 max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
        <p id="modal-body" class="text-gray-700 mb-4"></p>
        <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="btn-primary w-full">OK</button>
      </div>
    </div>
    
    <main id="app-container" class="w-full max-w-7xl">
      <h1 class="text-center text-4xl font-extrabold text-indigo-700 my-8">Loading...</h1>
    </main>

    <script>
      // =========================================================================
      // GLOBAL CONFIGURATION & STATE
      // =========================================================================
      
      // ðŸš¨ IMPORTANT: Replace with your actual deployed IP/domain if not using localhost
      const BASE_URL = "http://127.0.0.1:5000"; 
      let user = JSON.parse(localStorage.getItem("user")) || null;
      const appContainer = document.getElementById("app-container");
      let qrCodeInstance = null;
      let qrCodeScanner = null; // Global instance for HTML5 QR Code scanner

      // =========================================================================
      // UTILITIES
      // =========================================================================

      function showMessage(title, body) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-body").textContent = body;
        document.getElementById("message-modal").classList.remove("hidden");
      }

      async function apiFetch(url, options = {}) {
        try {
          const response = await fetch(BASE_URL + url, {
            ...options,
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
          });
          const data = await response.json();
          if (!response.ok) {
            showMessage("Error", data.error || "An unknown error occurred.");
            return null;
          }
          return data;
        } catch (error) {
          console.error("API Fetch Error:", error);
          showMessage("Network Error", "Could not connect to the server.");
          return null;
        }
      }

      function handleLogout() {
        localStorage.removeItem("user");
        user = null;
        renderLoginPage();
      }

      function generateQrCode(token) {
        const qrDiv = document.getElementById("qrcode");
        if (!qrDiv) return;

        qrDiv.innerHTML = ""; // Clear existing QR
        qrCodeInstance = new QRCode(qrDiv, {
          text: token,
          width: 128,
          height: 128,
          colorDark: "#4f46e5",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        document.getElementById("qr-token-display").textContent = token;
      }
      
      // =========================================================================
      // ADMIN DASHBOARD FUNCTIONS
      // =========================================================================
      
      // ðŸš¨ FIX: Refactored to read the new 'create_session_date' ID and send it to backend.
      async function handleCreateSession(e) {
        e.preventDefault();
        const class_name = document.getElementById('class_name').value;
        const class_code = document.getElementById('class_code').value;
        
        // ðŸŽ¯ CRITICAL FIX: Ensure the correct ID is read
        const dateInput = document.getElementById('create_session_date');
        if (!dateInput) {
            showMessage('Error', 'UI Error: Session Date input missing. Please refresh.');
            return;
        }
        
        const session_date = dateInput.value;

        if (!session_date) {
            showMessage('Error', 'Please select a date for the session.');
            return;
        }

        const data = await apiFetch("/admin/create_session", {
            method: "POST",
            body: JSON.stringify({
                class_name,
                class_code,
                class_id: user.class_id,
                date: session_date // ðŸŒŸ Send specific date to backend
            }),
        });

        if (data) {
            showMessage(
                "Session Created",
                `New session for ${class_code} active for ${session_date}.`
            );
            
            // Auto-switch the dashboard filter to the created date
            const filterInput = document.getElementById('attendance-date');
            if (filterInput) {
                filterInput.value = session_date;
            }

            // Generate QR code for the new token and refresh data
            generateQrCode(data.qr_token);
            fetchAdminData();
        }
      }

      async function fetchAdminData() {
        if (!user || !user.class_id) {
            console.error("User or Class ID missing.");
            return; 
        }

        const dateInput = document.getElementById('attendance-date');
        // Default to today if input doesn't exist yet, otherwise use input value
        const selectedDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        
        // Ensure the input visual shows the date being used
        if (dateInput && !dateInput.value) {
            dateInput.value = selectedDate;
        }

        const data = await apiFetch("/admin/attendance", {
            method: "POST", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                class_id: user.class_id,
                date: selectedDate // ðŸŒŸ SEND DATE TO BACKEND for filtering
            }),
        });

        if (data) {
            renderStatsTable(data.stats || []); 
            renderRecordsTable(data.records || []);

            // Handle QR Code Display on Data Fetch
            const token = data.current_qr_token;
            if (token) {
                // Only generate if the instance doesn't exist or is for a different token
                const currentTokenDisplay = document.getElementById("qr-token-display");
                if (!qrCodeInstance || currentTokenDisplay.textContent !== token) {
                    generateQrCode(token);
                }
            } else {
                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = '<p class="text-gray-500 text-center">No active session found. Create one above.</p>';
                document.getElementById("qr-token-display").textContent = "";
            }
        }
      }

      function renderStatsTable(stats) {
        const container = document.getElementById("stats-table-container");
        if (!container) return;
        
        // Safety check for empty stats
        if (stats.length === 0 || (stats.length > 0 && stats[0].total === 0)) {
            container.innerHTML =
                '<p class="text-gray-500">No session data or student data found for this date/class.</p>';
            return;
        }

        const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Roll No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Attended</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Total Sessions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Percentage</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${stats.map(stat => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stat.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${stat.rollno || "N/A"}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${stat.attended}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${stat.total}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${stat.percentage < 75 ? "text-red-600" : "text-green-600"}">${stat.percentage}%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button 
                                        onclick="handleDeleteStudentPrompt('${stat.id}', '${stat.name}')" 
                                        class="bg-red-100 text-red-700 hover:bg-red-200 border border-red-300 font-bold py-1 px-3 rounded text-xs transition duration-150"
                                    >
                                        Delete Student
                                    </button>
                                </td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }
      
      // Stub function for the delete button (requires confirmation)
      function handleDeleteStudentPrompt(student_id, student_name) {
          if (confirm(`Are you sure you want to delete student: ${student_name}? This action is irreversible and deletes all records.`)) {
              handleDeleteStudent(student_id);
          }
      }

      async function handleDeleteStudent(student_id) {
          const data = await apiFetch("/admin/delete_student", {
              method: "POST",
              body: JSON.stringify({ student_id }),
          });

          if (data) {
              showMessage("Success", data.message);
              fetchAdminData(); // Refresh table
          }
      }
      
      function updateAttendanceStatusHandler() {
          showMessage("Manual Update", "This feature needs a specific UI. Look at the 'Detailed Attendance Log' below and consider filtering by student to update specific records.");
          // A full implementation requires asking for record ID, new status, and calling /admin/update_attendance
      }
      
      function renderRecordsTable(records) {
        const container = document.getElementById("records-table-container");
        if (!container) return;
        
        if (records.length === 0) {
            container.innerHTML =
                '<p class="text-gray-500">No attendance records found for the selected date.</p>';
            return;
        }

        const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Roll No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Class Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${records.map(record => {
                            const date = new Date(record.timestamp * 1000).toLocaleString();
                            const statusColor = record.status === 'Present' ? 'text-green-600 font-bold' : 'text-red-600';
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.student_name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${record.roll_no || "N/A"}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${record.class_code}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${record.status}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${date}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button 
                                            onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" 
                                            class="bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-1 px-3 rounded text-xs transition duration-150"
                                        >
                                            Toggle to ${record.status === 'Present' ? 'Absent' : 'Present'}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }
      
      async function toggleAttendanceStatus(record_id, current_status) {
          const new_status = current_status === 'Present' ? 'Absent' : 'Present';
          
          const data = await apiFetch("/admin/update_attendance", {
              method: "POST",
              body: JSON.stringify({ record_id, status: new_status }),
          });

          if (data) {
              showMessage("Update Successful", `Record ${record_id} status changed to ${new_status}.`);
              fetchAdminData(); // Refresh table
          }
      }

      // ðŸš¨ FIX: Corrected function to prevent QR generation errors
      function renderAdminDashboard() {
        const today = new Date().toISOString().split('T')[0];

        appContainer.innerHTML = `
            <div class="flex flex-col space-y-8">
                <div class="flex justify-between items-center border-b pb-4">
                    <h2 class="text-4xl font-extrabold text-indigo-700">Admin Dashboard</h2>
                    <button onclick="handleLogout()" class="btn-secondary">Logout</button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg text-sm text-indigo-800 shadow-inner">
                    <p>Welcome, <strong>${user.name}</strong>. Managing Class ID: <strong>${user.class_id}</strong></p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-gray-700">ðŸ“… View Attendance History</h3>
                        <p class="text-sm text-gray-500">Select a date to filter the statistics and records below.</p>
                    </div>
                    <div>
                        <input 
                            type="date" 
                            id="attendance-date" 
                            value="${today}"
                            class="p-3 border-2 border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                            onchange="fetchAdminData()" 
                        >
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-8">
                    
                    <div class="card p-6 bg-indigo-50 rounded-xl shadow-xl col-span-2">
                        <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Start New Session (Generate QR)</h3>
                        <form id="create-session-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-indigo-700 mb-1">Class Name</label>
                                <input type="text" id="class_name" placeholder="E.g., Computer Science" required class="input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-indigo-700 mb-1">Class Code</label>
                                <input type="text" id="class_code" placeholder="E.g., CS101" required class="input-field">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-indigo-700 mb-1">Session Date (Required)</label>
                                <input 
                                    type="date" 
                                    id="create_session_date" 
                                    value="${today}" 
                                    required 
                                    class="input-field border-indigo-500"
                                >
                            </div>

                            <button type="submit" class="btn-primary w-full py-2 bg-indigo-600 hover:bg-indigo-700 transition duration-150">Generate New QR Code</button>
                        </form>
                    </div>

                    <div class="card p-6 bg-white rounded-xl shadow-xl flex flex-col items-center justify-center border-4 border-indigo-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Active QR Token</h3>
                        <div id="qrcode" class="p-3 border-4 border-indigo-500 rounded-lg bg-white mb-4 min-h-[150px] flex items-center justify-center">
                            <p class="text-gray-500 text-center">Generate a session to see QR.</p>
                        </div>
                        <p id="qr-token-display" class="text-lg font-bold text-indigo-600 truncate w-full text-center"></p>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-5 rounded-xl shadow-inner border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="updateAttendanceStatusHandler()" class="btn-secondary py-2 bg-teal-500 hover:bg-teal-600 text-white">
                            Manually Update Attendance
                        </button>
                        <button onclick="handleDeleteStudentPrompt()" class="btn-secondary py-2 bg-red-500 hover:bg-red-600 text-white">
                            Delete Student
                        </button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Student Statistics (Filtered)</h3>
                    <div id="stats-table-container" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>
                </div>

                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Detailed Attendance Log (Filtered)</h3>
                    <div id="records-table-container" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>
                </div>
            </div>
        `;
        
        // Attach event listener for session creation
        document.getElementById('create-session-form').onsubmit = handleCreateSession;
        
        // Initial Data Fetch based on today's date
        fetchAdminData();
      }

      // =========================================================================
      // STUDENT DASHBOARD FUNCTIONS (CAMERA SCANNER)
      // =========================================================================
      
      // ðŸš¨ NEW: Global instance for HTML5 QR Code scanner
      // let qrCodeScanner = null; (Declared globally at the top)

      // ðŸš¨ NEW: Function to initiate the camera scanner
      function startQrScanner() {
          const containerId = "scanner-container";
          const statusDiv = document.getElementById('attendance-status');
          
          if (qrCodeScanner) {
            qrCodeScanner.stop().catch(console.error);
          }
          
          qrCodeScanner = new Html5Qrcode(containerId);

          const html5QrCodeConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

          qrCodeScanner.start(
              { facingMode: "environment" }, // Request rear camera
              html5QrCodeConfig,
              
              // Success Callback: When a QR code is detected
              (decodedText, decodedResult) => {
                  // Stop scanning immediately upon success
                  qrCodeScanner.stop().then(() => {
                      const qr_token = decodedText.trim().toUpperCase();
                      // Submit the token to the backend
                      handleMarkAttendance(qr_token); 
                  }).catch(err => {
                      // Attempt to submit even if stopping fails
                      handleMarkAttendance(decodedText.trim().toUpperCase());
                      console.error("Error stopping scanner after success:", err);
                  });
              },
              
              // Error Callback (Show error only if camera fails to start)
              (errorMessage) => {
                  // This is called constantly, so only log for debugging
                  // console.log("QR Code Scan Error:", errorMessage);
              }
          ).catch((err) => {
              statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-100 text-red-800 text-center font-bold';
              statusDiv.textContent = `Camera Error: Could not start scanner. Check permissions or refresh.`;
              statusDiv.style.display = 'block';
              console.error("Failed to start scanner:", err);
          });
      }
      
      // ðŸš¨ REFACTORED: Now accepts the token directly from the scanner
      async function handleMarkAttendance(qr_token) {
          const student_id = user.user_id;
          const statusDiv = document.getElementById('attendance-status');
          
          statusDiv.className = 'mt-6 p-4 rounded-lg bg-yellow-100 text-yellow-800 text-center';
          statusDiv.textContent = `Submitting attendance...`;
          statusDiv.style.display = 'block';

          const data = await apiFetch("/student/mark_attendance", {
              method: "POST",
              body: JSON.stringify({ student_id, qr_token }),
          });

          if (data && data.status) {
              statusDiv.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800 text-center font-bold';
              statusDiv.textContent = data.message + " Scanner stopped.";
              
              fetchStudentStats(); // Refresh stats immediately
              
          } else if (data && data.error) {
              statusDiv.className = 'mt-6 p-4 rounded-lg bg-red-100 text-red-800 text-center font-bold';
              statusDiv.textContent = `Error: ${data.error}`;

              // If attendance failed, restart scanner to allow re-scan
              if (qrCodeScanner && !qrCodeScanner.isScanning) {
                  qrCodeScanner.start().catch(console.error);
              }
          }
      }

      function renderStudentDashboard() {
          appContainer.innerHTML = `
              <div class="max-w-xl mx-auto p-8 bg-white shadow-xl rounded-lg border-2 border-indigo-200">
                  <div class="flex justify-between items-center mb-6 border-b pb-3">
                      <h2 class="text-3xl font-bold text-indigo-700">Attendance Scanner ðŸ“¸</h2>
                      <button onclick="handleLogout()" class="btn-secondary">Logout</button>
                  </div>
                  <p class="text-gray-600 mb-4">Hello, <strong>${user.name}</strong>! Point your camera at the admin's QR code.</p>
                  
                  <div id="scanner-container" class="mb-6 p-2 border-4 border-indigo-500 rounded-lg overflow-hidden">
                      <p class="text-white text-center p-4">Loading camera...</p>
                  </div>
                  
                  <div id="attendance-status" class="mt-4 p-4 rounded-lg bg-gray-100 text-center hidden"></div>
                  
                  <h3 class="text-xl font-semibold text-gray-700 mt-10 mb-4 border-t pt-4">Your Overall Attendance</h3>
                  <div id="student-stats-container" class="bg-gray-50 p-4 rounded-lg">Loading statistics...</div>
              </div>
          `;
          
          // ðŸŒŸ NEW: Initialize the QR scanner and fetch stats
          startQrScanner();
          fetchStudentStats();
      }
      
      async function fetchStudentStats() {
          const statsContainer = document.getElementById('student-stats-container');
          if (!statsContainer) return;
          const student_id = user.user_id;

          const data = await apiFetch(`/student/stats/${student_id}`, { method: "GET" });

          if (data) {
              const percentage = data.percentage;
              const color = percentage >= 75 ? 'text-green-600' : 'text-red-600';
              
              statsContainer.innerHTML = `
                  <div class="grid grid-cols-3 gap-4 text-center">
                      <div class="p-3 border rounded-lg bg-blue-50">
                          <p class="text-2xl font-bold text-blue-700">${data.total_classes}</p>
                          <p class="text-sm text-gray-500">Total Classes</p>
                      </div>
                      <div class="p-3 border rounded-lg bg-green-50">
                          <p class="text-2xl font-bold text-green-700">${data.attended}</p>
                          <p class="text-sm text-gray-500">Attended</p>
                      </div>
                      <div class="p-3 border rounded-lg bg-red-50">
                          <p class="text-2xl font-bold text-red-700">${data.missed}</p>
                          <p class="text-sm text-gray-500">Missed</p>
                      </div>
                  </div>
                  <p class="text-4xl font-extrabold mt-6 text-center ${color}">Attendance: ${percentage}%</p>
              `;
          } else {
              statsContainer.textContent = "Could not load statistics.";
          }
      }

      // =========================================================================
      // LOGIN/REGISTRATION FUNCTIONS (Unchanged)
      // =========================================================================

      function renderLoginPage() {
        appContainer.innerHTML = `
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">QR Attendance Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="login-username" placeholder="Username" required class="input-field">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required class="input-field">
                    </div>
                    <button type="submit" class="btn-primary w-full">Login</button>
                </form>
                <p class="text-center mt-4">
                    Don't have an account? 
                    <button onclick="renderRegistrationPage()" class="text-indigo-600 hover:text-indigo-800 font-medium">Register here</button>
                </p>
            </div>
        `;
        document.getElementById("login-form").onsubmit = handleLogin;
      }
      
      async function handleLogin(e) {
          e.preventDefault();
          const username = document.getElementById("login-username").value;
          const password = document.getElementById("login-password").value;

          const data = await apiFetch("/login", {
              method: "POST",
              body: JSON.stringify({ username, password }),
          });

          if (data && data.user) {
              localStorage.setItem("user", JSON.stringify(data.user));
              user = data.user;
              initializeApp();
          }
      }

      function renderRegistrationPage() {
        appContainer.innerHTML = `
            <div class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Register</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <input type="text" id="reg-name" placeholder="Full Name" required class="input-field">
                    </div>
                    <div>
                        <input type="text" id="reg-username" placeholder="Username" required class="input-field">
                    </div>
                    <div>
                        <input type="password" id="reg-password" placeholder="Password" required class="input-field">
                    </div>
                    <div class="flex space-x-4">
                        <select id="reg-role" required class="input-field flex-1" onchange="toggleStudentFields(this.value)">
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="student">Student</option>
                        </select>
                        <input type="text" id="reg-class-id" placeholder="Class ID (e.g. CS-A)" required class="input-field flex-1">
                    </div>
                    <div id="student-fields" class="space-y-4 hidden">
                        <input type="text" id="reg-rollno" placeholder="Roll Number (Unique)" class="input-field">
                        <input type="text" id="reg-semester" placeholder="Semester" class="input-field">
                    </div>
                    <button type="submit" class="btn-primary w-full">Register</button>
                </form>
                <p class="text-center mt-4">
                    Already have an account? 
                    <button onclick="renderLoginPage()" class="text-indigo-600 hover:text-indigo-800 font-medium">Login here</button>
                </p>
            </div>
        `;
        document.getElementById("register-form").onsubmit = handleRegister;
      }

      function toggleStudentFields(role) {
          const fields = document.getElementById("student-fields");
          if (role === 'student') {
              fields.classList.remove('hidden');
              document.getElementById('reg-rollno').required = true;
              document.getElementById('reg-semester').required = true;
          } else {
              fields.classList.add('hidden');
              document.getElementById('reg-rollno').required = false;
              document.getElementById('reg-semester').required = false;
          }
      }
      
      async function handleRegister(e) {
          e.preventDefault();
          const role = document.getElementById("reg-role").value;
          const payload = {
              name: document.getElementById("reg-name").value,
              username: document.getElementById("reg-username").value,
              password: document.getElementById("reg-password").value,
              role: role,
              class_id: document.getElementById("reg-class-id").value,
          };

          if (role === 'student') {
              payload.rollno = document.getElementById("reg-rollno").value;
              payload.semester = document.getElementById("reg-semester").value;
          }

          const data = await apiFetch("/register", {
              method: "POST",
              body: JSON.stringify(payload),
          });

          if (data) {
              showMessage("Success", data.message);
              renderLoginPage();
          }
      }

      // =========================================================================
      // INITIALIZATION
      // =========================================================================

      function initializeApp() {
          if (user) {
              if (user.role === 'admin') {
                  renderAdminDashboard();
              } else if (user.role === 'student') {
                  renderStudentDashboard();
              }
          } else {
              renderLoginPage();
          }
      }

      initializeApp();
    </script>
  </body>
</html>
